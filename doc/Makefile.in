VPATH = @srcdir@
srcdir = @srcdir@
top_srcdir = @top_srcdir@
prefix = @prefix@
datarootdir = @datarootdir@
datadir = @datadir@
infodir = @infodir@

MI_OPTS = --fill-column 79 --no-split

OUT = M5manual.info M5manual.txt \
      html/M5manual_toc.html
#      M5manual.pdf

SRCS = M5manual.texi .version

all: ${OUT}

info: M5manual.info
M5manual.info: ${SRCS}
	makeinfo ${MI_OPTS} -D INFO -D INDEX M5manual.texi

txt: M5manual.txt
# M5manual.txt: M5manual.tex-no-info
#	makeinfo ${MI_OPTS} M5manual.tex-no-info

# ought to be
M5manual.txt: ${SRCS}
	makeinfo --plaintext ${MI_OPTS} -D INDEX --no-headers M5manual.texi > M5manual.txt

# old version
# M5manual.tex-no-info: ${SRCS}
# 	sed -e '/^@node/d' \
# 	    -e '/^@set INDEX/d' \
# 	    -e '/^@menu/,/^@end menu/d' \
# 	    -e '/^@setfilename/s/info/txt/' \
# 	    -e 's/@ref{\([^,}]*,\)*\([^}]*\)}/the section "\2"/' \
# 	    -e 's/@pxref{\([^,}]*,\)*\([^}]*\)}/see the section "\2"/' \
# 	    -e 's/@xref{\([^,}]*,\)*\([^}]*\)}/See the section "\2"/' \
# 	    < M5manual.texi > M5manual.tex-no-info

ps: M5manual.ps
M5manual.ps: M5manual.dvi
	dvips M5manual.dvi > M5manual.ps

dvi: M5manual.dvi
M5manual.dvi: ${SRCS}
	tex M5manual.texi
	texindex M5manual.fn
	tex M5manual.texi

pdf: M5manual.pdf
M5manual.pdf: ${SRCS}
	texi2pdf --clean --batch M5manual.texi


html: html/M5manual_toc.html
html/M5manual_toc.html: ${SRCS} Makefile common.css
	rm -rf html
#	texi2html -menu -split section -init_file t2hinit.pl -subdir html -top_file index.html -expand info M5manual.texi
	texi2any --html --output html --split=section --css-ref=common.css M5manual.texi
	cp -p common.css html
#	@echo ====================
#	@echo Checking for TexInfo commands left in the html...
#	-@texi2any -check html/M5manual_*.html || echo "Check failed; proceeding anyways."
#	@echo ====================


.version: $(top_srcdir)/.version
	{ echo '@macro m5version'; cat $(top_srcdir)/.version; echo; echo '@end macro'; }>.version

%.gz: %
	gzip -c $< > $@

clean:
	rm -f *~ M5manual.tex-no-info
	rm -f M5manual.cp M5manual.fn M5manual.ky
	rm -f M5manual.pg M5manual.tp M5manual.vr
	rm -f M5manual.log M5manual.aux M5manual.toc
	rm -f M5manual.fns
	rm -f M5manual.tmp

distclean: clean
	rm -f M5manual.dvi* M5manual.p* M5manual.i*
	rm -f M5manual.txt
	rm -rf html
